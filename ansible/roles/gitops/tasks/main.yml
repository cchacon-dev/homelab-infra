---
# === Ensure namespace exists ===
- name: "GitOps | Ensure namespace '{{ gitops_namespace }}'"
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ gitops_namespace }}"
    state: present
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Vars: compute fromEntities ===
- name: "Vars | Compute CNP fromEntities"
  ansible.builtin.set_fact:
    gitops_cnp_from_entities: >-
      {{
        ['host', 'remote-node', 'cluster']
        + (gitops_cnp_include_world | bool | ternary(['world'], []))
      }}
  tags: [gitops]

# === NetPol: permitir probes kubelet a 9440 y 9090 (temporal) ===
- name: "NetPol | Ensure probes are allowed towards 9440/tcp and 9090/tcp"
  kubernetes.core.k8s:
    state: present
    apply: true
    definition:
      apiVersion: cilium.io/v2
      kind: CiliumNetworkPolicy
      metadata:
        name: flux-allow-kubelet-probes
        namespace: "{{ gitops_namespace }}"
        labels:
          app.kubernetes.io/managed-by: ansible
      spec:
        endpointSelector: {}
        ingress:
          - fromEntities: "{{ gitops_cnp_from_entities }}"
            toPorts:
              - ports:
                  - port: "9440"
                    protocol: TCP
                  - port: "9090"
                    protocol: TCP
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Patch: normalize controller probes to use 9440/healthz ===
- name: "Patch | Normalize controller probes"
  vars:
    gitops_controllers:
      - source-controller
      - kustomize-controller
      - helm-controller
      - notification-controller
      - image-automation-controller
      - image-reflector-controller
  loop: "{{ gitops_controllers }}"
  kubernetes.core.k8s_json_patch:
    kind: Deployment
    namespace: "{{ gitops_namespace }}"
    name: "{{ item }}"
    patch:
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /healthz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 12
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /readyz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 12
      - op: add
        path: /spec/template/spec/containers/0/startupProbe
        value:
          httpGet:
            path: /healthz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 60
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Patch: source-controller specific timeouts ===
- name: "Patch | Source-controller probe overrides"
  kubernetes.core.k8s_json_patch:
    kind: Deployment
    namespace: "{{ gitops_namespace }}"
    name: source-controller
    patch:
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe
        value:
          httpGet:
            path: /readyz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 30
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe
        value:
          httpGet:
            path: /healthz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 12
      - op: replace
        path: /spec/template/spec/containers/0/startupProbe
        value:
          httpGet:
            path: /healthz
            port: healthz
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 60
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Patch: force Recreate strategy for all controllers ===
- name: "Patch | Use Recreate strategy to avoid duplicate pods"
  vars:
    gitops_controllers:
      - source-controller
      - kustomize-controller
      - helm-controller
      - notification-controller
      - image-automation-controller
      - image-reflector-controller
  loop: "{{ gitops_controllers }}"
  kubernetes.core.k8s_json_patch:
    kind: Deployment
    namespace: "{{ gitops_namespace }}"
    name: "{{ item }}"
    patch:
      - op: replace
        path: /spec/strategy
        value:
          type: Recreate
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Apply CiliumNetworkPolicies baseline (Flux internal) ===
- name: "GitOps | Render & apply CiliumNetworkPolicy (Flux baseline)"
  when: gitops_enable_flux_netpol | bool
  vars:
    cnp_templates:
      - cnp-flux-allow-intra-namespace.yaml.j2
      - cnp-flux-allow-dns.yaml.j2
      - cnp-flux-allow-egress-https.yaml.j2
      - cnp-flux-allow-kustomize-to-source.yaml.j2  # must allow port 80 and 9440
  loop: "{{ cnp_templates }}"
  loop_control:
    loop_var: cnp_tmpl
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', cnp_tmpl) | from_yaml }}"
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]

# === Wait for all controllers to become Ready ===
- name: "Ready | Wait for controllers to become available"
  vars:
    gitops_controllers:
      - source-controller
      - kustomize-controller
      - helm-controller
      - notification-controller
      - image-automation-controller
      - image-reflector-controller
  loop: "{{ gitops_controllers }}"
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ gitops_namespace }}"
    name: "{{ item }}"
  register: gitops_wait_deploy
  until: >
    (gitops_wait_deploy.resources | length) > 0 and
    (
      (gitops_wait_deploy.resources[0].status.conditions | default([]) |
       selectattr('type','equalto','Available') | map(attribute='status') | list) | first
    ) == 'True'
  retries: 40
  delay: 10
  changed_when: false
  environment:
    KUBECONFIG: "{{ gitops_kubeconfig }}"
  tags: [gitops]
